name: Block Private IPs

on:
  push:
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fail on private LAN IPv4 literals
        shell: bash
        run: |
          set -euo pipefail
          # IPv4 regex (simple) and private ranges to block
          IPV4='([0-9]{1,3}\.){3}[0-9]{1,3}'
          BLOCK='(^10\.|^127\.|^172\.(1[6-9]|2[0-9]|3[0-1])\.|^192\.168\.)'

          # Allowed RFC5737 doc nets for examples
          ALLOW_DOC='(192\.0\.2\.|198\.51\.100\.|203\.0\.113\.)'

          # Only scan code/config, skip docs & markdown & LICENSE
          find . -type f \
            \( -name '*.py' -o -name '*.sh' -o -name '*.ps1' -o -name '*.psm1' \
               -o -name '*.yml' -o -name '*.yaml' -o -name '*.ini' -o -name '*.env' \
               -o -name '*.conf' -o -name 'Dockerfile' \
               -o -name '*.txt' \) \
            ! -path './.git/*' \
            ! -path './docs/*' \
            ! -name 'README.md' \
            ! -name 'CHANGELOG.md' \
            ! -name 'LICENSE' \
          | xargs -r grep -nE "$IPV4" \
          | grep -Ev "$ALLOW_DOC" \
          | awk -F: '
              $3 ~ /([0-9]{1,3}\.){3}[0-9]{1,3}/ {
                ip=$3
                match(ip, /([0-9]{1,3}\.){3}[0-9]{1,3}/, m)
                if (m[0] ~ /'"$BLOCK"'/) { print; bad=1 }
              }
              END { exit bad }
            '
